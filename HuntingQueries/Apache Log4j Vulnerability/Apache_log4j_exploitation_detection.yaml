name: Possible exploitation of Apache log4j component detected
description: |
  'This hunting query looks for possible attempts to exploit a remote code execution vulnerability in the Log4j component of Apache. 
  Attackers may attempt to launch arbitrary code by passing specific commands to a server, which are then logged and executed by the Log4j component.
  For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
  Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'
requiredDataConnectors:
  - connectorId: Azure Web Application Firewall (WAF)
    dataTypes: 
      - AzureDiagnostics
tactics:
  - Persistence
  - Execution
relevantTechniques:
  - T1059
  - T1053
tags:
  - CVE-2021-44228
query: |
AzureDiagnostics
| where userAgent_s has_any ("${jndi:ldap:/", "${jndi:rmi:/", "${jndi:ldaps:/", "${jndi:dns:/") or requestUri_s has_any ("${jndi:ldap:/", "${jndi:rmi:/", "${jndi:ldaps:/", "${jndi:dns:/")
| project TimeGenerated, OperationName, requestUri_s, userAgent_s, clientIP_s, host_s, originalHost_s, sentBytes_d, receivedBytes_d